<div class="tasks-container">
  <!-- Header -->
  <div class="tasks-header">
    <h1 class="tasks-title">Task Management</h1>
    <div class="tasks-actions">
      <button class="action-btn search-btn" [class.active]="showSearchPanel" (click)="toggleSearchPanel()" title="Advanced Search">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </button>
      <button class="action-btn refresh-btn" (click)="applyFilters()" title="Refresh" [disabled]="isLoading">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" [class.spinning]="isLoading">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
          <path d="M21 3v5h-5"></path>
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
          <path d="M3 21v-5h5"></path>
        </svg>
      </button>
      <button class="btn btn-primary" (click)="addTask()">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M12 5v14M5 12h14"></path>
        </svg>
        Add Task
      </button>
    </div>
  </div>

  <!-- Advanced Search Panel -->
  <div *ngIf="showSearchPanel" class="search-panel">
    <div class="search-panel-header">
      <h3>Advanced Search</h3>
      <button class="close-btn" (click)="toggleSearchPanel()">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M18 6 6 18"/>
          <path d="m6 6 12 12"/>
        </svg>
      </button>
    </div>
    <div class="search-panel-content">
      <div class="search-filters">
        <div class="filter-item">
          <label>Search by Title/Description/MITS:</label>
          <input
            type="text"
            class="form-control"
            placeholder="Enter search term..."
            [(ngModel)]="searchTerm"
            (input)="onSearchChange()"
          />
        </div>
        
        <div class="filter-item">
          <label>Status:</label>
          <select class="form-control" [(ngModel)]="statusFilter" (change)="applyFilters()">
            <option value="">All Statuses</option>
            <option value="OPEN">Open</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="BLOCKED">Blocked</option>
            <option value="DONE">Done</option>
            <option value="CANCELLED">Cancelled</option>
          </select>
        </div>
        
        <div class="filter-item">
          <label>Priority:</label>
          <select class="form-control" [(ngModel)]="priorityFilter" (change)="applyFilters()">
            <option value="">All Priorities</option>
            <option value="LOW">Low</option>
            <option value="MEDIUM">Medium</option>
            <option value="HIGH">High</option>
            <option value="CRITICAL">Critical</option>
          </select>
        </div>

        <div class="filter-item">
          <label>Task Type:</label>
          <select class="form-control" [(ngModel)]="taskTypeFilter" (change)="applyFilters()">
            <option value="">All Task Types</option>
            <option *ngFor="let option of jobTypeOptions" [value]="option.label">{{ option.label }}</option>
          </select>
        </div>

        <div class="filter-item">
          <label>Product:</label>
          <select class="form-control" [(ngModel)]="productFilter" (change)="onProductChangeForFilter(); applyFilters()">
            <option value="">All Products</option>
            <option *ngFor="let p of products" [value]="p.id">{{ p.name }}</option>
          </select>
        </div>
        
        <div class="filter-item">
          <label>Module:</label>
          <select class="form-control" [(ngModel)]="moduleFilter" (change)="applyFilters()">
            <option value="">All Modules</option>
            <option *ngFor="let m of getModulesForProduct(productFilter)" [value]="m.id">{{ m.name }}</option>
          </select>
        </div>
        <div class="filter-item">
          <label>Assignee:</label>
          <select class="form-control" [(ngModel)]="assigneeFilter" (change)="applyFilters()">
            <option value="">All Assignees</option>
            <option *ngFor="let u of users" [value]="u.id">{{ getAssigneeName(u.id) }}</option>
          </select>
        </div>
        
        <div class="filter-item">
          <label>MITS No:</label>
          <input
            type="text"
            class="form-control"
            placeholder="Enter MITS number..."
            [(ngModel)]="mitsFilter"
            (input)="onSearchChange()"
          />
        </div>

        <div class="filter-item">
          <label>Deadline From:</label>
          <input
            type="date"
            class="form-control"
            [(ngModel)]="deadlineFrom"
            (change)="applyFilters()"
          />
        </div>

        <div class="filter-item">
          <label>Deadline To:</label>
          <input
            type="date"
            class="form-control"
            [(ngModel)]="deadlineTo"
            (change)="applyFilters()"
          />
        </div>
      </div>
      
      <div class="search-actions">
        <button class="btn btn-secondary" (click)="clearFilters()">Clear All</button>
        <button class="btn btn-primary" (click)="applyFilters()">Apply Filters</button>
      </div>
    </div>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="alert alert-error">
    {{ error }}
  </div>

  <!-- Table -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>MITS No</th>
          <th>Title</th>
          <th>Product</th>
          <th>Module</th>
          <th>Task Type</th>
          <th>Assignee</th>
          <th>Status</th>
          <th>Priority</th>
          <th>Deadline</th>
          <th>Points</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let t of paginated">
          <td>
            <div class="mits-badge">{{ t.mitsNo || '—' }}</div>
          </td>
          <td>
            <div class="task-title">{{ t.title }}</div>
            <div class="task-description" *ngIf="t.description">{{ t.description | slice:0:100 }}{{ t.description && t.description.length > 100 ? '...' : '' }}</div>
          </td>
          <td>{{ getProductName(t.productId) }}</td>
          <td>{{ getModuleName(t.productModuleId) }}</td>
          <td>
            <div class="type-badge">{{ getJobTypeName(t.taskType) }}</div>
          </td>
          <td>
            <div class="assignee-info">
              <div class="assignee-avatar">{{ getAssigneeInitials(t.assigneeUserId) }}</div>
              <span>{{ getAssigneeName(t.assigneeUserId) || 'Unassigned' }}</span>
            </div>
          </td>
          <td>
            <span class="status-badge" [ngClass]="'status-' + ((t.status || 'OPEN').toLowerCase().replace('_', '-'))">
              {{ t.status || 'OPEN' }}
            </span>
          </td>
          <td>
            <span class="priority-badge" [ngClass]="'priority-' + ((t.priority || 'MEDIUM').toLowerCase())">
              {{ t.priority || 'MEDIUM' }}
            </span>
          </td>
          <td>
            <div class="deadline-info" [class.overdue]="isOverdue(t.deadline)">
              {{ t.deadline ? (t.deadline | date:'MMM dd, yyyy') : '—' }}
              <div *ngIf="isOverdue(t.deadline)" class="overdue-label">Overdue</div>
            </div>
          </td>
          <td>
            <div class="points-badge">{{ t.points ?? '—' }}</div>
          </td>
          <td>
            <div class="actions-group">
              <button class="btn-outline" (click)="editTask(t)" title="Edit Task">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Edit
              </button>
              <button class="btn-outline delete-btn" (click)="askDelete(t)" title="Delete Task">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <polyline points="3,6 5,6 21,6"/>
                  <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                </svg>
                Delete
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="paginated.length === 0">
          <td colspan="11" class="empty-cell">
            <div class="empty-state">
              <div class="empty-icon">📋</div>
              <h3>No tasks found</h3>
              <p>Create your first task to get started with project management.</p>
              <button class="btn btn-primary" (click)="addTask()">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M12 5v14M5 12h14"></path>
                </svg>
                Create First Task
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination-container" *ngIf="!isLoading && filteredTasks && filteredTasks.length > 0">
    <div class="pagination-info">
      Showing {{ getStartIndex() }} to {{ getEndIndex() }} of {{ totalTasks }} tasks
    </div>
    <div class="pagination-controls">
      <button 
        class="pagination-btn" 
        (click)="goToPage(currentPage - 1)" 
        [disabled]="currentPage === 1 || isLoading"
        title="Previous Page">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <polyline points="15,18 9,12 15,6"/>
        </svg>
      </button>
      
      <div class="page-numbers">
        <button 
          *ngFor="let page of getVisiblePages()" 
          class="page-btn" 
          [class.active]="page === currentPage"
          (click)="goToPage(page)"
          [disabled]="isLoading">
          {{ page }}
        </button>
      </div>
      
      <button 
        class="pagination-btn" 
        (click)="goToPage(currentPage + 1)" 
        [disabled]="currentPage === totalPages || isLoading"
        title="Next Page">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <polyline points="9,18 15,12 9,6"/>
        </svg>
      </button>
    </div>
    <div class="page-size-selector">
      <label>Show:</label>
      <select class="form-control" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
      <span>per page</span>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal-overlay" *ngIf="isModalOpen">
    <div class="modal-container" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h3>{{ isEditMode ? 'Edit Task' : 'Add New Task' }}</h3>
        <button class="modal-close-btn" (click)="closeModal()" aria-label="Close">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M18 6 6 18"/>
            <path d="m6 6 12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal-content">
        <form [formGroup]="form" class="task-form" (ngSubmit)="saveTask()">
          <div class="form-grid">
            <div class="form-group">
              <label for="mitsNo">MITS No *</label>
              <input 
                id="mitsNo"
                class="form-control" 
                formControlName="mitsNo" 
                placeholder="Enter MITS number"
                [class.error]="form.get('mitsNo')?.invalid && form.get('mitsNo')?.touched"
              />
              <div *ngIf="form.get('mitsNo')?.invalid && form.get('mitsNo')?.touched" class="error-message">
                MITS No is required
              </div>
            </div>
            
            <div class="form-group">
              <label for="taskType">Task Type *</label>
              <select 
                id="taskType"
                class="form-control" 
                formControlName="taskType"
                [class.error]="form.get('taskType')?.invalid && form.get('taskType')?.touched"
              >
                <option value="" disabled>Select task type</option>
                <option *ngFor="let option of jobTypeOptions" [value]="option.value">{{ option.label }}</option>
              </select>
              <div *ngIf="form.get('taskType')?.invalid && form.get('taskType')?.touched" class="error-message">
                Task type is required
              </div>
            </div>
            
            <div class="form-group">
              <label for="productId">Product *</label>
              <select 
                id="productId"
                class="form-control" 
                formControlName="productId" 
                (change)="onProductChangeInForm()"
                [class.error]="form.get('productId')?.invalid && form.get('productId')?.touched"
              >
                <option value="" disabled>Select product</option>
                <option *ngFor="let p of products" [value]="p.id">{{ p.name }}</option>
              </select>
              <div *ngIf="form.get('productId')?.invalid && form.get('productId')?.touched" class="error-message">
                Product is required
              </div>
            </div>
            
            <div class="form-group">
              <label for="productModuleId">Product Module *</label>
              <select 
                id="productModuleId"
                class="form-control" 
                formControlName="productModuleId"
                [class.error]="form.get('productModuleId')?.invalid && form.get('productModuleId')?.touched"
              >
                <option value="" disabled>Select module</option>
                <option *ngFor="let m of getModulesForProduct(form.value.productId)" [value]="m.id">{{ m.name }}</option>
              </select>
              <div *ngIf="form.get('productModuleId')?.invalid && form.get('productModuleId')?.touched" class="error-message">
                Product module is required
              </div>
            </div>
            
            <div class="form-group form-group-full">
              <label for="title">Title *</label>
              <input 
                id="title"
                class="form-control" 
                formControlName="title" 
                placeholder="Enter task title"
                [class.error]="form.get('title')?.invalid && form.get('title')?.touched"
              />
              <div *ngIf="form.get('title')?.invalid && form.get('title')?.touched" class="error-message">
                <div *ngIf="form.get('title')?.errors?.['required']">Title is required</div>
                <div *ngIf="form.get('title')?.errors?.['minlength']">Title must be at least 3 characters</div>
              </div>
            </div>
            
            <div class="form-group form-group-full">
              <label for="description">Description</label>
              <textarea 
                id="description"
                class="form-control" 
                formControlName="description" 
                placeholder="Describe the task"
                rows="3"
              ></textarea>
            </div>
            
            <div class="form-group">
              <label for="assigneeUserId">Assign To</label>
              <select id="assigneeUserId" class="form-control" formControlName="assigneeUserId">
                <option value="">Unassigned</option>
                <option *ngFor="let u of users" [value]="u.id">{{ getAssigneeName(u.id) }}</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="status">Status *</label>
              <select 
                id="status"
                class="form-control" 
                formControlName="status"
                [class.error]="form.get('status')?.invalid && form.get('status')?.touched"
              >
                <option value="OPEN">Open</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="BLOCKED">Blocked</option>
                <option value="DONE">Done</option>
                <option value="CANCELLED">Cancelled</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="priority">Priority *</label>
              <select 
                id="priority"
                class="form-control" 
                formControlName="priority"
                [class.error]="form.get('priority')?.invalid && form.get('priority')?.touched"
              >
                <option value="LOW">Low</option>
                <option value="MEDIUM">Medium</option>
                <option value="HIGH">High</option>
                <option value="CRITICAL">Critical</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="deadline">Deadline</label>
              <input 
                id="deadline"
                class="form-control" 
                type="date" 
                formControlName="deadline"
              />
            </div>
            
            <div class="form-group">
              <label for="points">Points</label>
              <input 
                id="points"
                class="form-control" 
                type="number" 
                min="0" 
                formControlName="points"
                placeholder="0"
              />
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" (click)="closeModal()">Cancel</button>
        <button class="btn btn-primary" type="button" (click)="saveTask()" [disabled]="form.invalid">{{ isEditMode ? 'Save Changes' : 'Create Task' }}</button>
      </div>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal-overlay" *ngIf="isDeleteModalOpen">
    <div class="modal-container modal-small" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h3>Delete Task</h3>
        <button class="modal-close-btn" (click)="closeDelete()" aria-label="Close">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M18 6 6 18"></path>
            <path d="m6 6 12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-content">
        <div class="delete-confirmation">
          <div class="delete-icon">🗑️</div>
          <p>Are you sure you want to delete <strong>{{ selected?.title }}</strong>?</p>
          <div class="warning-text">This action cannot be undone.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" (click)="closeDelete()">Cancel</button>
        <button class="btn btn-danger" type="button" (click)="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
</div>
