<div class="tasks-container">
  <!-- Tasks Header -->
  <div class="tasks-header">
    <div class="header-content">
      <h1 class="tasks-title">Task Management</h1>
      <div class="tasks-actions">
        <button class="action-btn view-toggle-btn" (click)="toggleViewMode()" [title]="viewMode === 'list' ? 'Switch to Board View' : 'Switch to List View'">
          <svg *ngIf="viewMode === 'list'" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
          </svg>
          <svg *ngIf="viewMode === 'board'" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <line x1="8" y1="6" x2="21" y2="6"/>
            <line x1="8" y1="12" x2="21" y2="12"/>
            <line x1="8" y1="18" x2="21" y2="18"/>
            <line x1="3" y1="6" x2="3.01" y2="6"/>
            <line x1="3" y1="12" x2="3.01" y2="12"/>
            <line x1="3" y1="18" x2="3.01" y2="18"/>
          </svg>
        </button>
        <button class="action-btn refresh-btn" (click)="refreshTasks()" title="Refresh Tasks" [disabled]="isLoading">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" [class.spinning]="isLoading">
            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
            <path d="M21 3v5h-5"/>
            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
            <path d="M3 21v-5h5"/>
          </svg>
        </button>
        <button class="btn btn-primary" (click)="addTask()" [disabled]="isLoading">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          Add Task
        </button>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filter-row">
      <div class="filter-item">
        <input 
          type="text" 
          class="form-control" 
          placeholder="Search tasks..." 
          [(ngModel)]="searchTerm" 
          (input)="onSearchChange()">
      </div>
      <div class="filter-item">
        <select class="form-control" [(ngModel)]="selectedStatus" (change)="onFilterChange()">
          <option value="">All Status</option>
          <option value="TODO">To Do</option>
          <option value="IN_PROGRESS">In Progress</option>
          <option value="IN_REVIEW">In Review</option>
          <option value="TESTING">Testing</option>
          <option value="DONE">Done</option>
          <option value="BLOCKED">Blocked</option>
        </select>
      </div>
      <div class="filter-item">
        <select class="form-control" [(ngModel)]="selectedPriority" (change)="onFilterChange()">
          <option value="">All Priority</option>
          <option value="LOW">Low</option>
          <option value="MEDIUM">Medium</option>
          <option value="HIGH">High</option>
          <option value="CRITICAL">Critical</option>
        </select>
      </div>
      <div class="filter-item">
        <select class="form-control" [(ngModel)]="selectedAssignee" (change)="onFilterChange()">
          <option value="">All Assignees</option>
          <option *ngFor="let user of users" [value]="user.id">
            {{ user.firstName }} {{ user.lastName }}
          </option>
        </select>
      </div>
      <div class="filter-item">
        <button class="btn btn-secondary" (click)="clearFilters()">Clear Filters</button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Loading tasks...</p>
  </div>

  <!-- List View -->
  <div *ngIf="viewMode === 'list' && !isLoading" class="list-view">
    <div class="common-table-container" *ngIf="filteredTasks && filteredTasks.length > 0">
      <table class="common-table">
        <thead>
          <tr>
            <th>Task</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Type</th>
            <th>Assignee</th>
            <th>Module</th>
            <th>Sprint</th>
            <th>Due Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let task of filteredTasks; trackBy: trackByTaskId">
            <td>
              <div class="task-info">
                <div class="task-title" (click)="viewTaskDetails(task)">{{ task.title }}</div>
                <div class="task-description" *ngIf="task.description">{{ task.description | slice:0:100 }}{{ task.description.length > 100 ? '...' : '' }}</div>
              </div>
            </td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(task.status)">
                {{ task.status.replace('_', ' ') | titlecase }}
              </span>
            </td>
            <td>
              <span class="priority-badge" [ngClass]="getPriorityClass(task.priority)">
                {{ task.priority | titlecase }}
              </span>
            </td>
            <td>
              <span class="type-badge" [ngClass]="getTypeClass(task.type)">
                {{ task.type | titlecase }}
              </span>
            </td>
            <td>{{ task.assigneeName || 'Unassigned' }}</td>
            <td>{{ task.moduleName || 'No Module' }}</td>
            <td>{{ task.sprintName || 'No Sprint' }}</td>
            <td>{{ task.dueDate ? (task.dueDate | date:'shortDate') : '-' }}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-icon btn-edit" (click)="editTask(task)" title="Edit task">
                  <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="m18.5 2.5 3 3L12 15l-4 1 1-4z"/>
                  </svg>
                </button>
                <button class="btn-icon btn-delete" (click)="confirmDeleteTask(task)" title="Delete task">
                  <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="m3 6 3 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l3-12"/>
                    <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Board View (Kanban) -->
  <div *ngIf="viewMode === 'board' && !isLoading" class="board-view">
    <div class="kanban-board">
      <div *ngFor="let column of boardColumns" class="kanban-column" [class]="column.class">
        <div class="column-header">
          <h3>{{ column.title }}</h3>
          <span class="task-count">{{ getTasksByStatus(column.status).length }}</span>
        </div>
        <div class="column-content" 
             (drop)="onTaskDrop($event, column.status)" 
             (dragover)="$event.preventDefault()" 
             (dragenter)="$event.preventDefault()">
          <div *ngFor="let task of getTasksByStatus(column.status); trackBy: trackByTaskId" 
               class="task-card" 
               draggable="true" 
               (dragstart)="onTaskDragStart($event, task)"
               (click)="viewTaskDetails(task)">
            <div class="task-card-header">
              <span class="task-id">#{{ task.id }}</span>
              <span class="priority-indicator" [ngClass]="getPriorityClass(task.priority)"></span>
            </div>
            <div class="task-card-title">{{ task.title }}</div>
            <div class="task-card-meta">
              <span class="type-badge" [ngClass]="getTypeClass(task.type)">{{ task.type }}</span>
              <span class="assignee">{{ task.assigneeName || 'Unassigned' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && (!filteredTasks || filteredTasks.length === 0)" class="empty-state">
    <div class="empty-icon">
      <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24">
        <path d="M9 11l3 3L22 4"/>
        <path d="M21 12v5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h11"/>
      </svg>
    </div>
    <h3>No tasks found</h3>
    <p>Start by creating your first task or adjust your filters.</p>
    <button class="btn btn-primary" (click)="addTask()">
      Add First Task
    </button>
  </div>

  <!-- Add/Edit Task Modal -->
  <div class="modal-overlay" *ngIf="isAdd || isEdit" (click)="cancel()">
    <div class="modal-content large-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isAdd ? 'Add New Task' : 'Edit Task' }}</h2>
        <button class="btn-close" (click)="cancel()">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <form (ngSubmit)="saveTask()" class="task-form">
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="title">Task Title *</label>
            <input 
              type="text" 
              id="title"
              class="form-control" 
              [(ngModel)]="taskForm.title" 
              name="title" 
              placeholder="Enter task title"
              required>
          </div>

          <div class="form-group full-width">
            <label for="description">Description</label>
            <textarea 
              id="description"
              class="form-control" 
              [(ngModel)]="taskForm.description" 
              name="description" 
              rows="3"
              placeholder="Enter task description"></textarea>
          </div>

          <div class="form-group">
            <label for="status">Status</label>
            <select 
              id="status"
              class="form-control" 
              [(ngModel)]="taskForm.status" 
              name="status" 
              required>
              <option value="TODO">To Do</option>
              <option value="IN_PROGRESS">In Progress</option>
              <option value="IN_REVIEW">In Review</option>
              <option value="TESTING">Testing</option>
              <option value="DONE">Done</option>
              <option value="BLOCKED">Blocked</option>
            </select>
          </div>

          <div class="form-group">
            <label for="priority">Priority</label>
            <select 
              id="priority"
              class="form-control" 
              [(ngModel)]="taskForm.priority" 
              name="priority" 
              required>
              <option value="LOW">Low</option>
              <option value="MEDIUM">Medium</option>
              <option value="HIGH">High</option>
              <option value="CRITICAL">Critical</option>
            </select>
          </div>

          <div class="form-group">
            <label for="type">Type</label>
            <select 
              id="type"
              class="form-control" 
              [(ngModel)]="taskForm.type" 
              name="type" 
              required>
              <option value="FEATURE">Feature</option>
              <option value="BUG">Bug</option>
              <option value="IMPROVEMENT">Improvement</option>
              <option value="DOCUMENTATION">Documentation</option>
              <option value="RESEARCH">Research</option>
              <option value="TESTING">Testing</option>
            </select>
          </div>

          <div class="form-group">
            <label for="assigneeId">Assignee</label>
            <select 
              id="assigneeId"
              class="form-control" 
              [(ngModel)]="taskForm.assigneeId" 
              name="assigneeId">
              <option [value]="undefined">Select Assignee</option>
              <option *ngFor="let user of users" [value]="user.id">
                {{ user.firstName }} {{ user.lastName }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="moduleId">Module</label>
            <select 
              id="moduleId"
              class="form-control" 
              [(ngModel)]="taskForm.moduleId" 
              name="moduleId">
              <option [value]="undefined">Select Module</option>
              <option *ngFor="let module of modules" [value]="module.id">
                {{ module.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="sprintId">Sprint</label>
            <select 
              id="sprintId"
              class="form-control" 
              [(ngModel)]="taskForm.sprintId" 
              name="sprintId">
              <option [value]="undefined">Select Sprint</option>
              <option *ngFor="let sprint of sprints" [value]="sprint.id">
                {{ sprint.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="estimatedHours">Estimated Hours</label>
            <input 
              type="number" 
              id="estimatedHours"
              class="form-control" 
              [(ngModel)]="taskForm.estimatedHours" 
              name="estimatedHours" 
              min="0"
              step="0.5"
              placeholder="0">
          </div>

          <div class="form-group">
            <label for="dueDate">Due Date</label>
            <input 
              type="date" 
              id="dueDate"
              class="form-control" 
              [(ngModel)]="taskForm.dueDate" 
              name="dueDate">
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="cancel()">Cancel</button>
          <button type="submit" class="btn btn-primary">
            {{ isAdd ? 'Create Task' : 'Update Task' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showDeleteConfirm" (click)="cancelDelete()">
    <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Confirm Delete</h2>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the task <strong>{{ taskToDelete?.title }}</strong>?</p>
        <p class="warning-text">This action cannot be undone.</p>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancelDelete()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="deleteTask()">Delete</button>
      </div>
    </div>
  </div>
</div>
